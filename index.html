<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repton Student Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root { --accent: #2ecc71; --navy: #060e1b; --glass: rgba(255, 255, 255, 0.08); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        .fas, .far { font-family: "Font Awesome 5 Free" !important; font-weight: 900 !important; }

        body.house-new { --accent: #2ecc71; }
        body.house-orchard { --accent: #ff3b30; }
        body.house-latham { --accent: #007aff; }
        body.house-foremarke { --accent: #ff9500; }
        body.house-dahl { --accent: #af52de; }
        body.house-jumeirah { --accent: #55efc4; }
        body.house-school { --accent: #ffcc00; }

        body { background: var(--navy); color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; transition: 0.5s ease; overflow-x: hidden; }

        #login-screen, #settings-screen { position: fixed; inset: 0; background: var(--navy); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(25px); }
        #settings-screen { display: none; overflow-y: auto; padding: 20px; flex-direction: column; }
        #hub-ui { display: none; width: 100%; max-width: 450px; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--glass); border-radius: 24px; padding: 25px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 15px; width: 100%; border-bottom: 3px solid var(--accent); position: relative; transition: 0.3s; }
        input, select { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; width: 100%; padding: 14px; border-radius: 12px; outline: none; margin-bottom: 12px; font-size: 14px; }

        .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; }
        .btn-primary { background: var(--accent); color: var(--navy); }

        .day-selector { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .day-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 10px 12px; border-radius: 10px; cursor: pointer; font-size: 11px; font-weight: 700; transition: 0.2s; }
        .day-btn.active { background: var(--accent); color: var(--navy); border-color: var(--accent); }

        .progress-bar { background: rgba(255,255,255,0.05); height: 8px; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.5s ease; }

        /* New House Ending Alert */
        .ending-soon { box-shadow: 0 0 20px var(--accent); border-color: var(--accent); }
        .ending-bar { background: linear-gradient(90deg, var(--accent), #fff); animation: pulse-bar 1s infinite; }
        @keyframes pulse-bar { 50% { opacity: 0.6; } }

        .tag { font-size: 10px; font-weight: 900; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .bat-critical { color: #ff3b30 !important; animation: bat-pulse 1s infinite; }
        @keyframes bat-pulse { 50% { opacity: 0.3; } }
    </style>
</head>
<body id="app-body">

    <div id="login-screen">
        <div class="card" style="max-width: 350px; text-align: center;">
            <i class="fas fa-shield-alt" style="font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
            <h2 style="color: var(--accent); margin-bottom: 25px;">REPTON PORTAL</h2>
            <input type="text" id="username" placeholder="Enter Name">
            <select id="house-select" onchange="previewHouse(this.value)">
                <option value="new">New House (Green)</option>
                <option value="orchard">Orchard (Red)</option>
                <option value="latham">Latham (Blue)</option>
                <option value="foremarke">Foremarke (Orange)</option>
                <option value="dahl">Dahl (Purple)</option>
                <option value="jumeirah">Jumeirah (Teal)</option>
                <option value="school">School (Yellow)</option>
            </select>
            <button class="btn btn-primary" onclick="handleLogin()">ACCESS</button>
        </div>
    </div>

    <div id="settings-screen">
        <div class="card" style="max-width: 420px;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin:0;">Timetable Editor</h3>
                <i class="fas fa-times" onclick="closeSettings()" style="cursor:pointer; opacity:0.5;"></i>
            </div>

            <div class="day-selector">
                <button class="day-btn" id="d-btn-1" onclick="changeDay(1)">MON</button>
                <button class="day-btn" id="d-btn-2" onclick="changeDay(2)">TUE</button>
                <button class="day-btn" id="d-btn-3" onclick="changeDay(3)">WED</button>
                <button class="day-btn" id="d-btn-4" onclick="changeDay(4)">THU</button>
                <button class="day-btn" id="d-btn-5" onclick="changeDay(5)">FRI</button>
            </div>

            <div id="editor-grid" style="max-height: 45vh; overflow-y: auto; padding-right: 5px;"></div>

            <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <p style="font-size: 10px; opacity: 0.5; margin-bottom: 10px;">Switch House Theme</p>
                <select id="house-switch" onchange="previewHouse(this.value)">
                    <option value="new">New House</option>
                    <option value="orchard">Orchard</option>
                    <option value="latham">Latham</option>
                    <option value="foremarke">Foremarke</option>
                    <option value="dahl">Dahl</option>
                    <option value="jumeirah">Jumeirah</option>
                    <option value="school">School</option>
                </select>
                <button class="btn btn-primary" onclick="saveAll()">SAVE ALL CHANGES</button>
            </div>
        </div>
    </div>

    <div id="hub-ui">
        <div style="display: flex; justify-content: space-between; font-size: 11px; opacity: 0.8; margin-bottom: 12px; font-weight: 900;">
            <span><i class="far fa-clock"></i> <span id="clock">00:00</span></span>
            <span id="bat-container" style="display: flex; align-items: center; gap: 6px;">
                <span id="bat-pct">--%</span>
                <i id="bat-icon" class="fas fa-battery-full"></i>
            </span>
        </div>

        <div class="card" id="main-card">
            <span class="tag" id="house-tag">HOUSE</span>
            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <h2 id="greet">Hello</h2>
                <i class="fas fa-calendar-alt" onclick="openSettings()" style="cursor:pointer; opacity: 0.4; font-size: 18px;"></i>
            </div>

            <div style="margin-top: 25px;">
                <div id="cur-lesson" style="font-size: 32px; font-weight: 900; margin: 5px 0; line-height: 1.1;">--</div>
                <div id="timer" style="font-size: 11px; font-weight: 700; opacity: 0.5; letter-spacing: 0.5px;">STANDBY</div>
            </div>
            <div class="progress-bar"><div id="bar" class="progress-fill"></div></div>
        </div>

        <div class="card" style="padding: 15px; display: flex; justify-content: center; gap: 15px; align-items: center; border-bottom: none;">
            <i class="fas fa-map-marker-alt" style="color: var(--accent); font-size: 12px;"></i>
            <span style="font-size: 11px; font-weight: 900; opacity: 0.4;">NAD AL SHEBA</span>
            <h3 id="w-temp" style="font-size: 18px; font-weight: 900;">--°</h3>
        </div>
    </div>

    <script>
        let userData = { name: "", house: "new", schedule: {1:[], 2:[], 3:[], 4:[], 5:[]} };
        let activeEditDay = 1;

        const standardSlots = [
            { s: "07:40", e: "08:00", label: "Registration" },
            { s: "08:00", e: "09:00", label: "Lesson 1" },
            { s: "09:00", e: "10:00", label: "Lesson 2" },
            { s: "10:00", e: "10:20", label: "BREAK" },
            { s: "10:20", e: "11:20", label: "Lesson 3" },
            { s: "11:20", e: "12:20", label: "Lesson 4" },
            { s: "12:20", e: "13:00", label: "LUNCH" },
            { s: "13:00", e: "14:00", label: "Lesson 5" },
            { s: "14:00", e: "15:00", label: "Lesson 6" }
        ];

        const fridaySlots = [
            { s: "07:40", e: "08:00", label: "Registration" },
            { s: "08:00", e: "09:00", label: "Lesson 1" },
            { s: "09:00", e: "10:00", label: "Lesson 2" },
            { s: "10:00", e: "10:20", label: "BREAK" },
            { s: "10:20", e: "11:20", label: "Lesson 3" },
            { s: "11:20", e: "11:30", label: "Final Wrap" }
        ];

        function previewHouse(h) { document.body.className = `house-${h}`; }

        function handleLogin() {
            const name = document.getElementById('username').value.trim();
            const house = document.getElementById('house-select').value;
            if(!name) return;
            const saved = localStorage.getItem(`repton_v13_${name}`);
            userData = saved ? JSON.parse(saved) : { name, house, schedule: {1:[], 2:[], 3:[], 4:[], 5:[]} };
            saveToStorage();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('hub-ui').style.display = 'block';
            document.getElementById('house-tag').innerText = `${userData.house} House`;
            previewHouse(userData.house);
            start();
        }

        function openSettings() {
            activeEditDay = new Date().getDay() || 1;
            if(activeEditDay > 5) activeEditDay = 1;
            renderEditor();
            document.getElementById('settings-screen').style.display = 'flex';
        }

        function closeSettings() { document.getElementById('settings-screen').style.display = 'none'; }

        function changeDay(d) {
            saveInputs(); // Save what was typed in the previous day tab
            activeEditDay = d;
            renderEditor();
        }

        function renderEditor() {
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`d-btn-${activeEditDay}`).classList.add('active');

            const grid = document.getElementById('editor-grid');
            const slots = (activeEditDay === 5) ? fridaySlots : standardSlots;
            const dayData = userData.schedule[activeEditDay] || [];

            grid.innerHTML = slots.map((s, i) => `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <span style="font-size:10px; width:60px; opacity:0.3; font-weight:bold;">${s.s}</span>
                    <input class="tt-edit-input" data-idx="${i}" value="${dayData[i] || ''}" placeholder="${s.label}">
                </div>`).join('');
        }

        function saveInputs() {
            const inputs = document.querySelectorAll('.tt-edit-input');
            if(inputs.length) {
                const temp = [];
                inputs.forEach(inp => temp[inp.dataset.idx] = inp.value);
                userData.schedule[activeEditDay] = temp;
            }
        }

        function saveAll() {
            saveInputs();
            userData.house = document.getElementById('house-switch').value;
            saveToStorage();
            location.reload();
        }

        function saveToStorage() { localStorage.setItem(`repton_v13_${userData.name}`, JSON.stringify(userData)); localStorage.setItem('last_v13', userData.name); }

        function updateBattery(b) {
            const pct = Math.round(b.level * 100);
            const icon = document.getElementById('bat-icon');
            document.getElementById('bat-pct').innerText = pct + "%";
            icon.className = 'fas ';
            icon.classList.remove('bat-critical');
            if(b.charging) { icon.classList.add('fa-bolt'); icon.style.color = 'var(--accent)'; }
            else {
                icon.style.color = 'white';
                if(pct > 85) icon.classList.add('fa-battery-full');
                else if(pct > 65) icon.classList.add('fa-battery-three-quarters');
                else if(pct > 35) icon.classList.add('fa-battery-half');
                else if(pct > 15) icon.classList.add('fa-battery-quarter');
                else { icon.classList.add('fa-battery-empty'); icon.classList.add('bat-critical'); }
            }
        }

        function tick() {
            const now = new Date();
            const day = now.getDay();
            const mins = now.getHours() * 60 + now.getMinutes();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('greet').innerText = `Hey, ${userData.name.split(' ')[0]}`;

            let lesson = "Day Over", prog = 0, msg = "RELAX";
            let isEnding = false;

            if(day >= 1 && day <= 5) {
                const slots = (day === 5) ? fridaySlots : standardSlots;
                const endLimit = (day === 5) ? 690 : 900;

                slots.forEach((s, i) => {
                    const sM = parseInt(s.s.split(':')[0])*60 + parseInt(s.s.split(':')[1]);
                    const eM = parseInt(s.e.split(':')[0])*60 + parseInt(s.e.split(':')[1]);
                    if(mins >= sM && mins < eM) {
                        lesson = userData.schedule[day][i] || s.label;
                        prog = ((mins - sM) / (eM - sM)) * 100;
                        let rem = eM - mins;
                        msg = `${rem}m REMAINING`;
                        if(rem <= 5) isEnding = true;
                    }
                });
                if(mins >= endLimit) { lesson = "Dismissed"; msg = "GO HOME"; }
            }

            document.getElementById('cur-lesson').innerText = lesson;
            const bar = document.getElementById('bar');
            bar.style.width = prog + "%";

            // Visual Alert Logic
            const card = document.getElementById('main-card');
            if(isEnding) {
                card.classList.add('ending-soon');
                bar.classList.add('ending-bar');
            } else {
                card.classList.remove('ending-soon');
                bar.classList.remove('ending-bar');
            }

            document.getElementById('timer').innerText = msg;
        }

        async function start() {
            setInterval(tick, 1000);
            tick();
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=25.14&longitude=55.37&current=temperature_2m&timezone=auto');
                const d = await res.json();
                document.getElementById('w-temp').innerText = Math.round(d.current.temperature_2m) + "°";
            } catch(e) {}
            if(navigator.getBattery) {
                const b = await navigator.getBattery();
                if (document.fonts) { await document.fonts.ready; updateBattery(b); }
                b.onlevelchange = () => updateBattery(b);
                b.onchargingchange = () => updateBattery(b);
            }
        }

        window.onload = () => {
            const last = localStorage.getItem('last_v13');
            if(last) {
                const saved = localStorage.getItem(`repton_v13_${last}`);
                if(saved) { userData = JSON.parse(saved); handleLogin(); }
            }
        }
    </script>
</body>
</html>
