<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repton Pro Hub</title>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.1); --accent: #ffcc00; --navy: #1d427b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background: #0a192f; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 15px; overflow-x: hidden; }

        .card { background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 28px; padding: 22px; width: 100%; max-width: 380px; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 15px 35px rgba(0,0,0,0.3); position: relative; margin-top: 10px; }
        .lesson-text { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .progress-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .p-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.5s ease-in-out; }

        /* Weather UI */
        .weather-row { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .temp-val { font-size: 42px; font-weight: 200; display: flex; align-items: center; }
        .forecast-panel { display: none; flex-direction: column; gap: 15px; margin-top: 15px; width: 100%; max-width: 380px; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .scroll-x { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; scrollbar-width: none; }
        .hour-box { text-align: center; min-width: 55px; flex-shrink: 0; }
        .day-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 5px; }
        .w-icon { width: 45px; height: 45px; vertical-align: middle; }

        /* General Buttons/Modals */
        .main-btn { width: 100%; max-width: 380px; padding: 16px; border-radius: 20px; border: none; background: white; color: var(--navy); font-weight: 800; cursor: pointer; margin-top: 12px; transition: transform 0.1s; }
        .main-btn:active { transform: scale(0.98); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; z-index: 100; padding: 20px; align-items: center; justify-content: center; }
        .modal-box { background: #111; width: 100%; max-width: 400px; border-radius: 30px; padding: 25px; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        input { background: transparent; border: 1px solid transparent; color: white; padding: 8px; width: 100%; border-radius: 8px; }
        .locked input { pointer-events: none; opacity: 0.7; }
        .edit-on input { background: rgba(255,204,0,0.05); border-color: var(--accent); pointer-events: auto; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab { flex: 1; padding: 8px; border-radius: 8px; border: none; background: #222; color: #777; font-weight: 700; cursor: pointer; min-width: 60px; }
        .tab.active { background: var(--accent); color: var(--navy); }
        .live-clock { font-size: 12px; font-weight: 700; opacity: 0.5; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div style="width: 100%; max-width: 380px; margin: 15px 0;">
        <div class="live-clock" id="clock">00:00:00</div>
        <h1 id="greet" style="font-size: 24px;">Hello!</h1>
        <p id="vibe" style="color: var(--accent); font-size: 14px;">Ready for Repton?</p>
    </div>

    <div class="card">
        <span style="position:absolute; top:20px; right:20px; opacity:0.3; cursor:pointer;" onclick="openPop('setM')">‚öôÔ∏è</span>
        <div id="count" style="font-size:10px; font-weight:800; color:var(--accent); letter-spacing:1px; margin-bottom:5px;">--</div>
        <div id="status" class="lesson-text">Scanning...</div>
        <div class="progress-track"><div id="bar" class="p-bar"></div></div>

        <div class="weather-row" onclick="toggleForecast()" style="cursor:pointer">
            <div>
                <div class="temp-val"><img id="curIcon" src="" class="w-icon" style="margin-left:-10px"><span id="wT">--¬∞</span></div>
                <div id="wD" style="font-size: 12px; font-weight: 700; color: var(--accent); text-transform:uppercase;">Connect...</div>
            </div>
            <div style="text-align: right; font-size: 11px; opacity: 0.6;">
                Feels Like <span id="wF">--</span>¬∞<br>Wind <span id="wW">--</span> km/h
            </div>
        </div>
    </div>

    <div id="forecastPanel" class="forecast-panel">
        <div style="font-size:10px; opacity:0.5; text-transform:uppercase; margin-bottom:8px;">Next 24 Hours</div>
        <div class="scroll-x" id="hourlyBox"></div>
        <div style="font-size:10px; opacity:0.5; text-transform:uppercase; margin:8px 0;">Next 5 Days</div>
        <div id="dailyBox"></div>
    </div>

    <button class="main-btn" onclick="openPop('ttM')">üéí VIEW TIMETABLE</button>

    <div id="ttM" class="modal" onclick="if(event.target==this)this.style.display='none'">
        <div class="modal-box">
            <div class="tabs" id="tabs"></div>
            <table style="width:100%; border-collapse: collapse;"><tbody id="ttB"></tbody></table>
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px;">
                <label style="font-size:10px; color:var(--accent); font-weight:800;">TODAY'S LUNCH</label>
                <input id="lunchI" placeholder="Type menu..." oninput="saveL(this.value)" style="background:#222; margin-top:5px;">
            </div>
            <button class="main-btn" style="background:#333; color:white;" onclick="closePop('ttM')">Close</button>
        </div>
    </div>

    <div id="setM" class="modal" onclick="if(event.target==this)this.style.display='none'">
        <div class="modal-box" style="text-align:center">
            <h3>Hub Settings</h3>
            <div style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:15px; border-radius:15px; margin:20px 0;">
                <span>Master Edit Mode</span>
                <input type="checkbox" id="eCheck" onchange="isEd=this.checked;renderTT()" style="width:25px; height:25px">
            </div>
            <button class="main-btn" onclick="closePop('setM')">Done</button>
        </div>
    </div>

    <script>
        let times = JSON.parse(localStorage.getItem('rT')) || [["08:00","09:00"],["09:00","10:00"],["10:00","10:20"],["10:20","11:20"],["11:20","12:20"],["12:20","13:00"],["13:00","14:00"],["14:00","15:00"],["15:00","16:00"]];
        let subs = JSON.parse(localStorage.getItem('rS')) || {Mon:Array(9).fill("Subject"), Tue:Array(9).fill("Subject"), Wed:Array(9).fill("Subject"), Thu:Array(9).fill("Subject"), Fri:Array(9).fill("Subject")};
        let lunch = JSON.parse(localStorage.getItem('rL')) || {Mon:"",Tue:"",Wed:"",Thu:"",Fri:""};
        let curD = new Date().toLocaleDateString('en-US',{weekday:'short'});
        if(!['Mon','Tue','Wed','Thu','Fri'].includes(curD)) curD = 'Mon';
        let isEd = false;

        const weatherCodes = {
            0: "Clear Sky", 1: "Mainly Clear", 2: "Partly Cloudy", 3: "Overcast",
            45: "Fog", 48: "Rime Fog", 51: "Light Drizzle", 61: "Slight Rain",
            71: "Slight Snow", 95: "Thunderstorm"
        };

        function getOWMIcon(code, isNight = false) {
            const map = { 0:"01", 1:"01", 2:"02", 3:"03", 45:"50", 48:"50", 51:"09", 61:"10", 71:"13", 95:"11" };
            return `https://openweathermap.org/img/wn/${map[code] || "03"}${isNight ? 'n' : 'd'}@2x.png`;
        }

        async function getW() {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=25.1453&longitude=55.3790&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);
                const d = await res.json();
                const nowHr = new Date().getHours();

                document.getElementById('wT').innerText = Math.round(d.current.temperature_2m)+"¬∞";
                document.getElementById('wF').innerText = Math.round(d.current.apparent_temperature);
                document.getElementById('wW').innerText = Math.round(d.current.wind_speed_10m);
                document.getElementById('curIcon').src = getOWMIcon(d.current.weather_code, nowHr > 18 || nowHr < 6);
                document.getElementById('wD').innerText = weatherCodes[d.current.weather_code] || "Mostly Clear";

                const hBox = document.getElementById('hourlyBox'); hBox.innerHTML = '';
                for(let i = 0; i < 24; i++) {
                    const dateObj = new Date(d.hourly.time[i + nowHr]);
                    if(!dateObj) break;
                    const hr = dateObj.getHours();
                    hBox.innerHTML += `<div class="hour-box"><div style="font-size:10px">${i===0?'Now':hr+':00'}</div><img src="${getOWMIcon(d.hourly.weather_code[i+nowHr], hr>18||hr<6)}" class="w-icon"><div>${Math.round(d.hourly.temperature_2m[i+nowHr])}¬∞</div></div>`;
                }

                const dBox = document.getElementById('dailyBox'); dBox.innerHTML = '';
                for(let i=1; i<6; i++) {
                    const dayName = new Date(d.daily.time[i]).toLocaleDateString('en-US',{weekday:'short'});
                    dBox.innerHTML += `<div class="day-row"><span>${dayName}</span><img src="${getOWMIcon(d.daily.weather_code[i])}" class="w-icon"><span>${Math.round(d.daily.temperature_2m_max[i])}¬∞ <small style="opacity:0.4">${Math.round(d.daily.temperature_2m_min[i])}¬∞</small></span></div>`;
                }
            } catch(e) { console.error("Weather failed", e); }
        }

        const openPop = (id) => { document.getElementById(id).style.display='flex'; if(id=='ttM') renderTT(); };
        const closePop = (id) => document.getElementById(id).style.display='none';
        const toggleForecast = () => { const p = document.getElementById('forecastPanel'); p.style.display = p.style.display==='flex'?'none':'flex'; };
        const saveT = (r,c,v) => { times[r][c]=v; localStorage.setItem('rT', JSON.stringify(times)); tick(); };
        const saveS = (r,v) => { subs[curD][r]=v; localStorage.setItem('rS', JSON.stringify(subs)); tick(); };
        const saveL = (v) => { lunch[curD]=v; localStorage.setItem('rL', JSON.stringify(lunch)); };

        function renderTT() {
            const t = document.getElementById('tabs'); t.innerHTML = '';
            ['Mon','Tue','Wed','Thu','Fri'].forEach(d => t.innerHTML += `<button class="tab ${d==curD?'active':''}" onclick="curD='${d}';renderTT()">${d}</button>`);
            const b = document.getElementById('ttB'); b.innerHTML = '';
            b.parentElement.className = isEd ? "edit-on" : "locked";
            times.forEach((tm, i) => b.innerHTML += `<tr><td><input value="${tm[0]}" oninput="saveT(${i},0,this.value)" ${isEd?'':'readonly'}></td><td><input value="${tm[1]}" oninput="saveT(${i},1,this.value)" ${isEd?'':'readonly'}></td><td><input value="${subs[curD][i] || 'Subject'}" oninput="saveS(${i},this.value)" ${isEd?'':'readonly'}></td></tr>`);
            document.getElementById('lunchI').value = lunch[curD] || "";
        }

        function tick() {
            const now = new Date();
            const h = now.getHours(), m = now.getMinutes();
            const mins = h * 60 + m;
            const day = now.toLocaleDateString('en-US',{weekday:'short'});
            
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB');
            document.getElementById('greet').innerText = h < 12 ? "Good Morning!" : h < 17 ? "Good Afternoon!" : "Good Evening!";
            
            let active = false;
            if(subs[day]) {
                const startStr = times[0][0], endStr = times[times.length-1][1];
                const startM = parseInt(startStr.split(':')[0])*60 + parseInt(startStr.split(':')[1]);
                const endM = parseInt(endStr.split(':')[0])*60 + parseInt(endStr.split(':')[1]);

                if (mins >= startM && mins < endM) {
                    document.getElementById('count').innerText = `${endM - mins} MINS UNTIL HOME TIME üè†`;
                } else {
                    document.getElementById('count').innerText = mins >= endM ? "SCHOOL'S FINISHED" : "STARTING SOON";
                }

                times.forEach((t, i) => {
                    const st = parseInt(t[0].split(':')[0])*60 + parseInt(t[0].split(':')[1]);
                    const en = parseInt(t[1].split(':')[0])*60 + parseInt(t[1].split(':')[1]);
                    if(mins >= st && mins < en) {
                        document.getElementById('status').innerText = `Now: ${subs[day][i]}`;
                        document.getElementById('bar').style.width = ((mins - st) / (en - st) * 100) + "%";
                        active = true;
                    }
                });
            } else {
                document.getElementById('count').innerText = "ENJOY YOUR WEEKEND";
            }
            
            if(!active) { 
                document.getElementById('status').innerText = "School's Out ‚ú®"; 
                document.getElementById('bar').style.width = "0%"; 
            }
        }

        getW(); setInterval(tick, 1000); tick();
    </script>
</body>
</html>
